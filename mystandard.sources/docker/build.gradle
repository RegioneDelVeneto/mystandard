/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn how to create Gradle builds at https://guides.gradle.org/creating-new-gradle-builds
 */

plugins {
    id "com.palantir.docker" version "0.25.0"
    id "de.undercouch.download" version "4.0.4"
}

ext.artifactGroup = 'it/regioneveneto/myp3'
ext.artifactName = 'mystandard'
ext.artifactVersion='1.1.3'
ext.artifactExtension='jar'

version='1.1.3.NOSSL' // image version tag
ext.imageName='mystandard'    // name image

// image build arguments
//ext.IMAGE_BASE_VERSION='1.3.14' // versione immagine di base usata nel dockerfile => al momento non si usa una immagine di base

task downloadFile(type: Download) {
    description "Download file"
    def fileName="${artifactName}-${artifactVersion}.${artifactExtension}"
    src "${gradle.mavenReleasesRepoUrl}${artifactGroup}/${artifactName}/${artifactVersion}/${fileName}"
    dest "${buildDir}/docker/${fileName}"
    username "${gradle.mavenCredentialsUsername}"
    password "${gradle.mavenCredentialsPassword}"
    authScheme 'Basic'
}

docker {
    dependsOn downloadFile
    def fileName="${artifactName}-${artifactVersion}.${artifactExtension}"
    println "${imageName}:${project.version}"
    println "${buildDir}/docker/${fileName}"

    name "${gradle.registry}/${imageName}:${project.version}"
    dockerfile file('dockerfile')

    // add extra files read by Dockerfile in ADD method
    files   'config/application.yml',
            'config/application-detail.yml',
            'config/application-env.yml',
            'config/CLV-AP_IT.rdf',
            'config/COV-AP_IT.rdf',
            'config/default_state_machine.xml',
            'config/legal-status.rdf',
            'config/index_definition.json',
            'config/mybox.properties',
            'config/mystd_bpo.owl',
            'config/SM-AP_IT.rdf',
            'config/TI-AP_IT.rdf',
            'config/TSI.owl',
            'config/TSI_data.owl',
            "${buildDir}/docker/${fileName}",
            'setup-rve-mystandard.sh',
            'start-rve-mystandard.sh',
            'wait-for-it.sh'
//    buildArgs(['http_proxy':"${gradle.http_proxy}",
//               'https_proxy':"${gradle.https_proxy}"])
//               'MYPLACE_VERSION':"${IMAGE_BASE_VERSION}"])
}
